<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solvimport System V4.3</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

    <style>
        /* CSS CORE */
        :root {
            --bg-dark: #0f172a; --card-dark: #1e293b; --primary: #06b6d4;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --text-light: #f8fafc;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-light); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .mobile-header {
            padding: 15px 20px; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; left: 0; right: 0; z-index: 50;
        }
        .app-title { font-weight: 800; font-size: 18px; color: var(--primary); }
        .app-status { font-size: 10px; padding: 4px 8px; border-radius: 12px; background: #334155; color: #94a3b8; font-weight: bold; transition: all 0.3s; }

        /* PREVIEW AREA */
        .preview-container { flex: 1; overflow-y: auto; padding: 80px 15px 120px 15px; display: flex; flex-direction: column; align-items: center; }

        /* REPORT PAPER */
        #report-paper {
            width: 100%; max-width: 600px; background: white; color: #334155; padding: 20px; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); font-size: 12px;
        }
        .paper-header { border-bottom: 2px solid #0f172a; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .logo-text { font-size: 22px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }
        .sub-text { font-size: 9px; color: #64748b; letter-spacing: 2px; text-transform: uppercase; }
        
        .paper-card { border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 15px; page-break-inside: avoid; }
        .card-title { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; display: flex; align-items: center; gap: 5px; justify-content: space-between; }
        
        .filter-container { background: #f1f5f9; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e2e8f0; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; }
        .date-input { flex: 1; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px; background: white; }
        .btn-filter { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; }

        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
        @media (min-width: 500px) { .charts-grid { grid-template-columns: 1fr 1fr; } .full-width-chart { grid-column: span 2; } }
        .chart-box { height: 200px; position: relative; width: 100%; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 3px; }
        .stat-sub-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px; color: #64748b; padding-left: 10px; border-bottom: none; }
        .stat-val { font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #0f172a; }
        .big-val { font-size: 20px; font-weight: 800; color: #0f172a; }
        .issue-text { font-style: italic; color: #9f1239; background: #fff1f2; padding: 8px; border-radius: 4px; font-size: 10px; border-left: 3px solid #ef4444; margin-top: 5px; }

        /* FAB & EDITOR */
        .fab-container { position: fixed; bottom: 30px; right: 20px; left: 20px; z-index: 100; pointer-events: none; }
        .btn-fab { pointer-events: auto; width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 50px; font-weight: 700; font-size: 14px; box-shadow: 0 4px 25px rgba(6, 182, 212, 0.5); display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: transform 0.2s; }
        .btn-fab:active { transform: scale(0.95); }

        .bottom-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; justify-content: flex-end; backdrop-filter: blur(5px); }
        .sheet-content { background: var(--card-dark); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px 20px; max-height: 85vh; overflow-y: auto; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .sheet-title { font-size: 18px; font-weight: 700; color: white; }
        .btn-close { background: none; border: none; color: #94a3b8; font-size: 24px; padding: 5px; cursor: pointer; }

        .form-label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; margin-top: 15px; font-weight: 600; }
        .form-input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; font-size: 16px; }
        
        .btn-action-row { display: flex; gap: 10px; margin-top: 30px; }
        .btn-save { flex: 1; background: var(--success); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; }
        .btn-pdf { flex: 1; background: #eab308; color: #422006; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-delete { width: 100%; background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 12px; border-radius: 12px; font-weight: bold; font-size: 12px; margin-top: 20px; cursor: pointer; }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.95); z-index: 5000; display:flex; justify-content:center; align-items:center; color:var(--primary); font-weight:bold; flex-direction:column; gap:15px; display: none; }
        
        .error-banner { background: #ef4444; color: white; padding: 10px; text-align: center; font-size: 12px; font-weight: bold; display: none; margin-bottom: 10px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="loader"><i class="fa-solid fa-circle-notch fa-spin fa-3x"></i><span id="loader-text">Memproses...</span></div>

    <div class="mobile-header">
        <div class="app-title">SOLVIMPORT <span style="font-weight:400; font-size:14px; color:#94a3b8;">V4.3</span></div>
        <div class="app-status" id="db-status">CHECKING DB...</div>
    </div>

    <!-- PREVIEW AREA -->
    <div class="preview-container">
        
        <!-- ERROR MESSAGE -->
        <div id="error-msg" class="error-banner"></div>

        <div id="report-paper">
            <div class="paper-header">
                <div>
                    <div class="logo-text">SOLVIMPORT</div>
                    <div class="sub-text">ANALYTICS DASHBOARD</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 9px; color: #94a3b8; font-weight: bold;">TANGGAL DATA</div>
                    <div style="font-size: 11px; font-weight: bold;" id="out-date">...</div>
                </div>
            </div>

            <div class="paper-card" data-html2canvas-ignore="true">
                <div class="card-title">
                    <span><i class="fa-solid fa-calendar-days" style="color:#0f172a;"></i> FILTER GRAFIK</span>
                </div>
                <div class="filter-container">
                    <span class="filter-label">Tampilkan data dari:</span>
                    <input type="date" id="filter-start" class="date-input">
                    <span style="font-size:10px; color:#64748b;">s/d</span>
                    <input type="date" id="filter-end" class="date-input">
                    <button class="btn-filter" onclick="applyDateFilter()">UPDATE GRAFIK</button>
                </div>
            </div>

            <div class="paper-card">
                <div class="card-title">
                    <span><i class="fa-solid fa-chart-pie" style="color:#2563eb;"></i> PERFORMANCE METRICS</span>
                    <span style="font-size:9px; color:#64748b;" id="chart-period-label">30 Hari Terakhir</span>
                </div>
                <div class="charts-grid">
                    <div class="chart-box full-width-chart"><canvas id="funnelChart"></canvas></div>
                    <div class="chart-box"><canvas id="winRateChart"></canvas></div>
                    <div class="chart-box"><canvas id="mixChart"></canvas></div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="paper-card" style="margin:0;">
                    <div class="card-title"><i class="fa-solid fa-bullhorn" style="color:#d97706;"></i> HARIAN (H)</div>
                    <div class="stat-row"><span>Leads</span><span class="stat-val" id="out-leads">0</span></div>
                    <div class="stat-row"><span>Closing Tot</span><span class="stat-val" id="out-total-closing">0</span></div>
                    <div class="stat-sub-row"><span>‚Ä¢ Kursus</span><span class="stat-val" id="out-course">0</span></div>
                    <div class="stat-sub-row"><span>‚Ä¢ Jasa</span><span class="stat-val" id="out-service">0</span></div>
                    <div class="stat-row" style="border:none; margin-top:5px;"><span>Conv. Rate</span><span class="stat-val" id="out-rate" style="color:#16a34a;">0%</span></div>
                </div>

                <div class="paper-card" style="margin:0; background: #f0fdf4; border-color:#bbf7d0;">
                    <div class="card-title"><i class="fa-solid fa-wallet" style="color:#16a34a;"></i> CASHFLOW</div>
                    <div class="big-val" style="font-size:16px;" id="out-omset">Rp 0</div>
                    <div style="font-size:10px; color:#16a34a; font-weight:bold; margin-top:5px;" id="out-status-audit">PENDING</div>
                </div>
            </div>

            <div class="paper-card" style="margin-top:15px;">
                <div class="card-title"><i class="fa-solid fa-box" style="color:#64748b;"></i> OPS & ISU HARIAN</div>
                <div class="stat-row"><span>Item</span><span class="stat-val" id="out-log-name">-</span></div>
                <div class="stat-row"><span>Volume</span><span class="stat-val" id="out-log-cbm">0 CBM</span></div>
                <div class="stat-row" style="border:none;"><span>Bukti Foto</span><span class="stat-val" id="out-log-status" style="color:#ef4444;">NO</span></div>
                <div class="issue-text">"<span id="out-issue">-</span>"</div>
            </div>
            
            <div style="margin-top:20px; text-align:center; font-size:8px; color:#94a3b8; border-top:1px dashed #e2e8f0; padding-top:10px;">GENERATED BY SOLVIMPORT V4.3</div>
        </div>
    </div>

    <!-- FAB -->
    <div class="fab-container">
        <button class="btn-fab" onclick="openSheet()"><i class="fa-solid fa-pen-to-square"></i> KELOLA DATA</button>
    </div>

    <!-- EDITOR SHEET -->
    <div class="bottom-sheet" id="editorSheet" onclick="closeSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-header">
                <div class="sheet-title">Input Laporan Harian</div>
                <button class="btn-close" onclick="closeSheetDirect()"><i class="fa-solid fa-times"></i></button>
            </div>

            <label class="form-label" style="color:var(--primary);">PILIH TANGGAL (Input Data)</label>
            <input type="date" class="form-input" id="inp-date" onchange="loadDataByDate()" style="border: 1px solid var(--primary);">

            <label class="form-label">Marketing: Leads</label>
            <input type="tel" class="form-input" id="inp-leads" placeholder="0" oninput="updateUI()">

            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label class="form-label">Clos Kursus</label><input type="tel" class="form-input" id="inp-course" placeholder="0" oninput="updateUI()"></div>
                <div style="flex:1;"><label class="form-label">Clos Jasa</label><input type="tel" class="form-input" id="inp-service" placeholder="0" oninput="updateUI()"></div>
            </div>

            <label class="form-label">Isu / Komplain</label>
            <input type="text" class="form-input" id="inp-issue" placeholder="Catatan..." oninput="updateUI()">

            <label class="form-label">Keuangan: Omset (Rp)</label>
            <input type="tel" class="form-input" id="inp-omset" placeholder="0" oninput="updateUI()">

            <label class="form-label">Status Audit</label>
            <select class="form-input" id="inp-status-audit" onchange="updateUI()">
                <option value="PENDING ‚ö†Ô∏è">PENDING ‚ö†Ô∏è</option>
                <option value="VERIFIED ‚úÖ">VERIFIED ‚úÖ</option>
            </select>

            <label class="form-label">Logistik: Item & CBM</label>
            <div style="display:flex; gap:10px;">
                <input type="text" class="form-input" id="inp-log-name" placeholder="Nama" oninput="updateUI()">
                <input type="text" class="form-input" id="inp-log-cbm" placeholder="CBM" oninput="updateUI()">
            </div>
            <select class="form-input" id="inp-log-status" onchange="updateUI()" style="margin-top:10px;">
                <option value="NO">NO FOTO ‚ùå</option>
                <option value="OK">FOTO OK ‚úÖ</option>
            </select>

            <div class="btn-action-row">
                <button class="btn-save" onclick="saveDataOnly()">SIMPAN</button>
                <button class="btn-pdf" onclick="saveAndExportPDF()">SIMPAN & PDF</button>
            </div>
            
            <button class="btn-delete" onclick="deleteData()">HAPUS DATA</button>
            <div style="height:50px;"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://tzheufnxsgjhydovaoja.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6aGV1Zm54c2dqaHlkb3Zhb2phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzk1MzQsImV4cCI6MjA4MDk1NTUzNH0.ePMDXCYuF4cgs9JKWC6V26taX3PCK12lS2HqqvtU9J8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let chartFunnel, chartWinRate, chartMix;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inp-date').value = today;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('filter-start').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('filter-end').value = today;

            checkConnection();
            loadDataByDate();
        });

        // --- DIAGNOSTIC ---
        async function checkConnection() {
            const statusEl = document.getElementById('db-status');
            const errorEl = document.getElementById('error-msg');
            
            try {
                // Test Query Ringan
                const { data, error } = await supabase.from('daily_reports').select('id').limit(1);
                
                if (error) {
                    console.error("DB Error:", error);
                    statusEl.innerText = "DB ERROR üî¥";
                    statusEl.style.color = "#ef4444";
                    errorEl.style.display = 'block';
                    errorEl.innerText = "Koneksi Gagal: " + error.message + ". Pastikan Anda sudah menjalankan Kode SQL di Supabase!";
                } else {
                    statusEl.innerText = "DB ONLINE üü¢";
                    statusEl.style.color = "#10b981";
                    errorEl.style.display = 'none';
                }
            } catch (err) {
                console.error("Network Error:", err);
                statusEl.innerText = "NETWORK ERR";
                errorEl.style.display = 'block';
                errorEl.innerText = "Gagal menghubungi Supabase. Cek internet Anda.";
            }
        }

        // --- CORE LOGIC ---
        function applyDateFilter() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            if(!start || !end) { alert("Pilih tanggal dulu."); return; }
            document.getElementById('chart-period-label').innerText = `Periode: ${start} s/d ${end}`;
            loadChartAnalytics(start, end);
        }

        async function saveDataInternal() {
            showLoader(true);
            const date = document.getElementById('inp-date').value;
            const payload = {
                report_date: date,
                leads_count: parseInt(document.getElementById('inp-leads').value)||0,
                closing_course: parseInt(document.getElementById('inp-course').value)||0,
                closing_service: parseInt(document.getElementById('inp-service').value)||0,
                omset: parseInt(document.getElementById('inp-omset').value)||0,
                issue_text: document.getElementById('inp-issue').value,
                status_audit: document.getElementById('inp-status-audit').value,
                logistics_data: [{ name: document.getElementById('inp-log-name').value, cbm: document.getElementById('inp-log-cbm').value, status: document.getElementById('inp-log-status').value }]
            };
            const { error } = await supabase.from('daily_reports').upsert(payload, { onConflict: 'report_date' });
            showLoader(false);
            if (error) { alert("GAGAL SIMPAN: " + error.message); return false; }
            return true;
        }

        async function saveDataOnly() {
            if(await saveDataInternal()) { closeSheetDirect(); alert("Data Tersimpan!"); applyDateFilter(); }
        }

        async function saveAndExportPDF() {
            // Save DB first, then PDF
            const success = await saveDataInternal();
            
            // Generate PDF anyway
            closeSheetDirect();
            showLoader(true);
            
            const filterSection = document.querySelector('.paper-card[data-html2canvas-ignore="true"]');
            if(filterSection) filterSection.style.display = 'none';

            setTimeout(() => {
                const element = document.getElementById('report-paper');
                const date = document.getElementById('inp-date').value;
                const opt = { margin: 0, filename: `Solvimport_${date}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: [140, 220], orientation: 'portrait' } };
                html2pdf().set(opt).from(element).save().then(() => {
                    showLoader(false);
                    if(filterSection) filterSection.style.display = 'block';
                }).catch(e => {
                    showLoader(false);
                    if(filterSection) filterSection.style.display = 'block';
                    alert("Gagal Export PDF: " + e.message);
                });
            }, 800);
        }

        async function loadDataByDate() {
            showLoader(true);
            const date = document.getElementById('inp-date').value;
            document.getElementById('out-date').innerText = date.split('-').reverse().join(' ');
            
            const { data, error } = await supabase.from('daily_reports').select('*').eq('report_date', date).single();
            
            if (data) {
                document.getElementById('inp-leads').value = data.leads_count;
                document.getElementById('inp-course').value = data.closing_course;
                document.getElementById('inp-service').value = data.closing_service;
                document.getElementById('inp-omset').value = data.omset;
                document.getElementById('inp-issue').value = data.issue_text || '';
                document.getElementById('inp-status-audit').value = data.status_audit || 'PENDING ‚ö†Ô∏è';
                if (data.logistics_data && data.logistics_data[0]) {
                    document.getElementById('inp-log-name').value = data.logistics_data[0].name;
                    document.getElementById('inp-log-cbm').value = data.logistics_data[0].cbm;
                    document.getElementById('inp-log-status').value = data.logistics_data[0].status;
                }
            } else { resetFormInputs(); }
            
            updateUI();
            applyDateFilter();
            showLoader(false);
        }

        async function deleteData() {
            if(!confirm("Hapus data tanggal ini?")) return;
            showLoader(true);
            await supabase.from('daily_reports').delete().eq('report_date', document.getElementById('inp-date').value);
            showLoader(false); resetFormInputs(); updateUI(); applyDateFilter(); alert("Data Dihapus.");
        }

        // --- SAFE UI UPDATE ---
        function updateUI() {
            // Helper safe setter
            const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            
            const leads = document.getElementById('inp-leads').value || 0;
            const course = document.getElementById('inp-course').value || 0;
            const service = document.getElementById('inp-service').value || 0;
            const issue = document.getElementById('inp-issue').value;
            const omset = document.getElementById('inp-omset').value;
            const status = document.getElementById('inp-status-audit').value;
            const logName = document.getElementById('inp-log-name').value;
            const logCbm = document.getElementById('inp-log-cbm').value;
            const logStatus = document.getElementById('inp-log-status').value;

            setTxt('out-leads', leads);
            setTxt('out-course', course);
            setTxt('out-service', service);
            setTxt('out-total-closing', parseInt(course) + parseInt(service));
            setTxt('out-rate', leads > 0 ? Math.round(((parseInt(course)+parseInt(service))/leads)*100)+'%' : '0%');
            setTxt('out-issue', issue || 'Belum ada catatan.');
            setTxt('out-omset', "Rp " + parseInt(omset || 0).toLocaleString('id-ID'));
            setTxt('out-log-name', logName || '-');
            setTxt('out-log-cbm', (logCbm || '0') + ' CBM');
            
            const sEl = document.getElementById('out-status-audit');
            if(sEl) {
                sEl.innerText = status;
                sEl.style.color = status.includes('VERIFIED') ? '#16a34a' : '#ef4444';
                sEl.style.borderColor = status.includes('VERIFIED') ? '#16a34a' : '#ef4444';
            }
            const lEl = document.getElementById('out-log-status');
            if(lEl) {
                lEl.innerText = logStatus;
                lEl.style.color = logStatus === 'OK' ? '#16a34a' : '#ef4444';
            }
        }

        // --- CHARTING ---
        async function loadChartAnalytics(startDate, endDate) {
            if(!startDate) startDate = document.getElementById('filter-start').value;
            if(!endDate) endDate = document.getElementById('filter-end').value;

            const { data } = await supabase.from('daily_reports')
                .select('report_date, leads_count, closing_course, closing_service')
                .gte('report_date', startDate).lte('report_date', endDate)
                .order('report_date', {ascending:true});

            if (!data || data.length === 0) return;

            const labels = data.map(d => d.report_date.slice(5));
            const leads = data.map(d => d.leads_count);
            const closings = data.map(d => d.closing_course + d.closing_service);
            const course = data.map(d => d.closing_course);
            const service = data.map(d => d.closing_service);

            // 1. Funnel
            const ctx1 = document.getElementById('funnelChart').getContext('2d');
            if (chartFunnel) chartFunnel.destroy();
            chartFunnel = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Leads', data: leads, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                        { label: 'Closing', data: closings, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.3, fill: true, pointRadius: 2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {labels:{boxWidth: 8, font:{size:9}}} }, scales: { x:{ticks:{font:{size:8}}}, y:{ticks:{font:{size:8}}} }, interaction: { mode: 'index', intersect: false } }
            });

            // 2. Win Rate
            const totalClose = closings.reduce((a,b)=>a+b, 0);
            const totalFail = leads.reduce((a,b)=>a+b, 0) - totalClose;
            const ctx2 = document.getElementById('winRateChart').getContext('2d');
            if (chartWinRate) chartWinRate.destroy();
            chartWinRate = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: ['Deal', 'Miss'], datasets: [{ data: [totalClose, totalFail], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `WIN RATE (${totalClose})`, font: {size: 9} }, legend: { display: false } }, cutout: '65%' }
            });

            // 3. Mix
            const ctx3 = document.getElementById('mixChart').getContext('2d');
            if (chartMix) chartMix.destroy();
            chartMix = new Chart(ctx3, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Kursus', data: course, backgroundColor: '#f59e0b' }, { label: 'Jasa', data: service, backgroundColor: '#6366f1' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'SUMBER CUAN', font: {size: 9} }, legend: { display: false } }, scales: { x:{stacked:true, display:false}, y:{stacked:true, display:false} } }
            });
        }

        function resetFormInputs() {
            ['leads', 'course', 'service', 'omset', 'log-cbm'].forEach(id => document.getElementById('inp-'+id).value = '');
            document.getElementById('inp-issue').value = '';
            document.getElementById('inp-status-audit').value = 'PENDING ‚ö†Ô∏è';
            document.getElementById('inp-log-name').value = '';
            document.getElementById('inp-log-status').value = 'NO';
        }

        function openSheet() { document.getElementById('editorSheet').style.display = 'flex'; }
        function closeSheet(e) { if(e.target.id === 'editorSheet') closeSheetDirect(); }
        function closeSheetDirect() { document.getElementById('editorSheet').style.display = 'none'; }
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    </script>
</body>
</html>
